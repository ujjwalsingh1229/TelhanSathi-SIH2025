{% extends "base.html" %}

{% block title %}My Bids - Mandi Connect{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/bidding.css') }}">
{% endblock %}

{% block content %}
<div class="my-bids-container">
    <!-- Header -->
    <div class="page-header">
        <h1>üí∞ My Bids</h1>
        <p class="subtitle">Track all your bids and auction status</p>
    </div>

    <!-- Tabs -->
    <div class="tabs-section">
        <button class="tab-btn active" onclick="switchTab('all')">All Bids</button>
        <button class="tab-btn" onclick="switchTab('winning')">Winning</button>
        <button class="tab-btn" onclick="switchTab('outbid')">Outbid</button>
        <button class="tab-btn" onclick="switchTab('ended')">Ended Auctions</button>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <span class="stat-number" id="totalBids">0</span>
                <span class="stat-label">Total Bids</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üèÜ</div>
            <div class="stat-content">
                <span class="stat-number" id="winningBids">0</span>
                <span class="stat-label">Winning Bids</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-content">
                <span class="stat-number" id="outbidCount">0</span>
                <span class="stat-label">Outbid</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
                <span class="stat-number" id="completedCount">0</span>
                <span class="stat-label">Completed</span>
            </div>
        </div>
    </div>

    <!-- Bids List -->
    <div class="bids-section">
        <div class="bids-list" id="bidsList">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p>Loading your bids...</p>
            </div>
        </div>
    </div>

    <!-- No Bids Message -->
    <div id="noBids" class="empty-state" style="display: none;">
        <h2>üòï No bids yet</h2>
        <p>Start bidding on auctions to see them here</p>
        <a href="/bidding/buyer/auctions" class="btn-primary">Browse Auctions ‚Üí</a>
    </div>
</div>

<!-- Bid Card Template -->
<template id="bidCardTemplate">
    <div class="bid-card">
        <!-- Header -->
        <div class="bid-card-header">
            <div class="bid-crop-info">
                <h3 class="crop-name" id="cropName">Soybean</h3>
                <span class="bid-location" id="location">üìç Indore, MP</span>
            </div>
            <div class="bid-status" id="statusBadge">WINNING</div>
        </div>

        <!-- Body -->
        <div class="bid-card-body">
            <!-- Auction Details -->
            <div class="bid-detail-row">
                <span class="detail-label">Auction ID:</span>
                <span class="detail-value mono" id="auctionId">auction-12345</span>
            </div>

            <div class="bid-detail-row">
                <span class="detail-label">Your Bid:</span>
                <span class="detail-value highlight" id="yourBid">‚Çπ5,650</span>
            </div>

            <div class="bid-detail-row">
                <span class="detail-label">Base Price:</span>
                <span class="detail-value" id="basePrice">‚Çπ5,500</span>
            </div>

            <div class="bid-detail-row">
                <span class="detail-label">Current Highest:</span>
                <span class="detail-value" id="currentBid">‚Çπ5,650</span>
            </div>

            <div class="bid-detail-row">
                <span class="detail-label">Quantity:</span>
                <span class="detail-value" id="quantity">10 Q</span>
            </div>

            <!-- Bid Timestamps -->
            <div class="bid-timestamps">
                <div class="timestamp">
                    <span class="time-label">Bid Placed:</span>
                    <span class="time-value" id="bidTime">10:30 AM</span>
                </div>
                <div class="timestamp">
                    <span class="time-label">Auction Ends:</span>
                    <span class="time-value" id="auctionEnd">Dec 10, 5:30 PM</span>
                </div>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="bid-card-footer">
            <button class="btn-secondary" id="viewBtn" onclick="viewAuction()">View Auction</button>
            <button class="btn-primary" id="placeBidBtn" onclick="placeBidAgain()">Place Higher Bid</button>
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
<script>
    let allBids = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadMyBids();
    });

    // Load user's bids
    function loadMyBids() {
        fetch('/bidding/buyer/my-bids')
            .then(res => res.json())
            .then(data => {
                allBids = data.bids || [];
                
                // Update statistics
                updateStatistics(allBids);
                
                // Display all bids
                switchTab('all');
            })
            .catch(err => {
                console.error('Error loading bids:', err);
                showError('Failed to load your bids');
            });
    }

    // Switch tab
    function switchTab(tab) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Filter and display bids
        let filteredBids = allBids;

        switch(tab) {
            case 'winning':
                filteredBids = allBids.filter(b => b.is_winning && !b.auction_ended);
                break;
            case 'outbid':
                filteredBids = allBids.filter(b => b.is_outbid);
                break;
            case 'ended':
                filteredBids = allBids.filter(b => b.auction_ended);
                break;
        }

        displayBids(filteredBids);
    }

    // Display bids
    function displayBids(bids) {
        const container = document.getElementById('bidsList');
        const noData = document.getElementById('noBids');

        if (bids.length === 0) {
            container.style.display = 'none';
            noData.style.display = 'block';
            return;
        }

        container.style.display = 'block';
        noData.style.display = 'none';
        container.innerHTML = bids.map(bid => {
            const template = document.getElementById('bidCardTemplate').content.cloneNode(true);
            
            // Fill template
            template.querySelector('.bid-card').dataset.auctionId = bid.auction_id;
            
            template.getElementById('cropName').textContent = bid.crop_name;
            template.getElementById('location').textContent = `üìç ${bid.location || 'Location TBD'}`;
            template.getElementById('auctionId').textContent = bid.auction_id.substring(0, 12) + '...';
            template.getElementById('yourBid').textContent = `‚Çπ${formatNumber(bid.bid_amount)}`;
            template.getElementById('basePrice').textContent = `‚Çπ${formatNumber(bid.base_price)}`;
            template.getElementById('currentBid').textContent = `‚Çπ${formatNumber(bid.current_highest_bid)}`;
            template.getElementById('quantity').textContent = `${bid.quantity} Q`;
            template.getElementById('bidTime').textContent = formatTime(bid.bid_timestamp);
            template.getElementById('auctionEnd').textContent = formatTime(bid.auction_end_time);

            // Status badge
            const statusBadge = template.getElementById('statusBadge');
            if (bid.auction_ended) {
                if (bid.is_winning) {
                    statusBadge.textContent = 'üèÜ WON';
                    statusBadge.className = 'bid-status status-won';
                } else {
                    statusBadge.textContent = '‚ùå LOST';
                    statusBadge.className = 'bid-status status-lost';
                }
            } else if (bid.is_winning) {
                statusBadge.textContent = 'üèÜ WINNING';
                statusBadge.className = 'bid-status status-winning';
            } else {
                statusBadge.textContent = '‚ö†Ô∏è OUTBID';
                statusBadge.className = 'bid-status status-outbid';
            }

            // Button handlers
            const auctionId = bid.auction_id;
            template.getElementById('viewBtn').onclick = () => {
                window.location.href = `/bidding/auction-detail/${auctionId}`;
            };
            
            template.getElementById('placeBidBtn').onclick = () => {
                window.location.href = `/bidding/auction-detail/${auctionId}`;
            };

            // Hide place bid button if auction ended
            if (bid.auction_ended) {
                template.getElementById('placeBidBtn').style.display = 'none';
            }

            return template;
        }).reduce((frag, node) => {
            frag.appendChild(node);
            return frag;
        }, document.createDocumentFragment());
    }

    // Update statistics
    function updateStatistics(bids) {
        const totalBids = bids.length;
        const winningBids = bids.filter(b => b.is_winning && !b.auction_ended).length;
        const outbidCount = bids.filter(b => b.is_outbid).length;
        const completedCount = bids.filter(b => b.auction_ended && b.is_winning).length;

        document.getElementById('totalBids').textContent = totalBids;
        document.getElementById('winningBids').textContent = winningBids;
        document.getElementById('outbidCount').textContent = outbidCount;
        document.getElementById('completedCount').textContent = completedCount;
    }

    // Helper functions
    function formatNumber(num) {
        return new Intl.NumberFormat('en-IN').format(num);
    }

    function formatTime(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function showError(message) {
        const container = document.getElementById('bidsList');
        container.innerHTML = `<div class="error-message">${message}</div>`;
    }
</script>
{% endblock %}
