{% extends "base.html" %}

{% block title %}{{ crop }} Sell Harvest - Telhan Sathi{% endblock %}

{% block style %}
    <link href="https://fonts.googleapis.com/css2?family=Hind:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #2E7D32;
            --light-green: #E8F5E9;
            --slider-track: #e6e6e6;
            --slider-fill: #C8E6C9;
            --thumb-border: #D4AF37;
            --text-dark: #1e3a24;
            --white: #ffffff;
            --gold: #D4AF37;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Hind', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #f5f5f5;
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .app-container {
            width: 100%;
            max-width: 450px;
            background-color: var(--white);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

       

        .content {
            padding: 20px;
            flex: 1;
        }

        .crop-badge {
            display: inline-flex;
            align-items: center;
            background: var(--light-green);
            padding: 8px 16px;
            border-radius: 20px;
            color: var(--primary-green);
            font-weight: 600;
            margin-bottom: 24px;
        }

        .crop-badge span { margin-left: 8px; }

        /* --- 1. QUANTITY SECTION --- */
        .input-section {
            margin-bottom: 25px;
            background: #fff;
        }

        .label-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 16px;
        }

        .unit { color: #888; font-size: 14px; }

        /* Slider Styles */
        .range-wrapper {
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            z-index: 2;
            position: relative;
        }

        input[type=range]:focus { outline: none; }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 12px;
            cursor: pointer;
            background: var(--slider-track);
            border-radius: 10px;
        }

        input[type=range]::-webkit-slider-thumb {
            height: 32px;
            width: 32px;
            border-radius: 50%;
            background: var(--white);
            border: 4px solid var(--thumb-border);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            position: relative;
            z-index: 3;
        }

        .slider-progress {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            left: 0;
            height: 12px;
            background: var(--slider-fill);
            border-radius: 10px;
            width: 50%;
            z-index: 1;
        }

        .manual-input {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px;
            width: 100%;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
        }

        /* --- 2. PRICE INPUT SECTION (NEW) --- */
        .price-container {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .price-box {
            flex: 1;
        }

        .price-input-wrapper {
            position: relative;
        }

        .currency-symbol {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            font-weight: bold;
        }

        .price-input {
            width: 100%;
            padding: 12px 12px 12px 30px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            color: var(--text-dark);
        }
        
        .price-input:focus {
            border-color: var(--primary-green);
            outline: none;
        }

        .market-ref {
            font-size: 12px;
            color: var(--primary-green);
            margin-top: 5px;
            display: flex;
            align-items: center;
        }

        /* --- 3. TOTAL EARNINGS CARD --- */
        .earnings-card {
            background: var(--white);
            border: 2px solid var(--light-green);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        /* Decorative background circle */
        .earnings-card::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 80px;
            height: 80px;
            background: var(--light-green);
            border-radius: 50%;
            opacity: 0.5;
        }

        .earnings-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .total-amount {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-green);
            display: block;
            line-height: 1.2;
        }
        
        .math-breakdown {
            font-size: 14px;
            color: #888;
            margin-top: 5px;
        }

        /* --- Form Fields --- */
        .form-group { margin-bottom: 24px; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        .date-input {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            background: #fff;
        }

        /* Footer */
        .footer-actions {
            padding: 20px;
            background: var(--white);
            border-top: 1px solid #eee;
            position: sticky;
            bottom: 0;
        }

        .btn-submit {
            width: 100%;
            background: var(--primary-green);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
            cursor: pointer;
        }
        
        /* Photo grid styling (Compact) */
        .photo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .photo-box {
            aspect-ratio: 1;
            background: #f9f9f9;
            border: 2px dashed #ccc;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            overflow: hidden;
            position: relative;
        }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .photo-box.has-image { border: 2px solid var(--primary-green); }

    </style>
{% endblock %}
{% block content %}
<div class="app-container">
        <h2>Sell Your Harvest</h2>


    <div class="content">
        <div class="crop-badge">
            <span id="cropNameDisplay">Mustard</span>
        </div>

        <div class="input-section">
            <div class="label-row">
                <span>Quantity (‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ)</span>
                <span class="unit">Quintals</span>
            </div>
            <div class="range-wrapper">
                <div class="slider-progress" id="sliderProgress"></div>
                <input type="range" id="quantitySlider" min="1" max="100" value="50" step="1">
            </div>
            <input type="number" id="manualQty" class="manual-input" value="50">
        </div>

        <div class="input-section">
            <div class="label-row">
                <span>Expected Price (‡§ï‡•Ä‡§Æ‡§§)</span>
                <span class="unit">Per Quintal</span>
            </div>
            <div class="price-input-wrapper">
                <span class="currency-symbol">‚Çπ</span>
                <input type="number" id="priceInput" class="price-input" value="5450">
            </div>
            <div class="market-ref">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:4px"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                Market Rate: ‚Çπ<span id="marketRateDisplay">5450</span>
            </div>
        </div>

        <div class="earnings-card">
            <div class="earnings-label">Est. Total Earnings (‡§ï‡•Å‡§≤ ‡§ï‡§Æ‡§æ‡§à)</div>
            <span class="total-amount" id="totalMath">‚Çπ2,72,500</span>
            <div class="math-breakdown">
                <span id="qtyMath">50</span> Qtl √ó ‚Çπ<span id="priceMath">5,450</span>
            </div>
        </div>

        <div class="form-group">
            <label>Harvest Date (‡§ï‡§ü‡§æ‡§à ‡§ï‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ)</label>
            <input type="date" id="harvestDate" class="date-input">
        </div>

        <div class="form-group">
            <label>Photos (‡§§‡§∏‡•ç‡§µ‡•Ä‡§∞‡•á‡§Ç)</label>
            <div class="photo-grid">
                <div class="photo-box" onclick="document.getElementById('file1').click()">
                    <input type="file" id="file1" hidden accept="image/*" onchange="previewImage(this, 'img1')">
                    <span style="font-size:20px; color:#ccc;">üì∑</span>
                    <img id="img1">
                </div>
                <div class="photo-box" onclick="document.getElementById('file2').click()">
                    <input type="file" id="file2" hidden accept="image/*" onchange="previewImage(this, 'img2')">
                    <span style="font-size:20px; color:#ccc;">üì∑</span>
                    <img id="img2">
                </div>
                <div class="photo-box" onclick="document.getElementById('file3').click()">
                    <input type="file" id="file3" hidden accept="image/*" onchange="previewImage(this, 'img3')">
                    <span style="font-size:20px; color:#ccc;">üì∑</span>
                    <img id="img3">
                </div>
            </div>
        </div>
    </div>
        <button id="submitBtn" class="btn-submit" onclick="submitSellRequest()">
            <span>Confirm Request</span>
        </button>
        <br><br><br>
</div>
{% endblock %}

{% block script %}
<script>
    // --- 1. INITIALIZATION ---
    const params = new URLSearchParams(window.location.search);
    const cropName = params.get('crop') || 'Mustard';
    const marketRate = parseFloat(params.get('price')) || 5450;

    // Elements
    const slider = document.getElementById('quantitySlider');
    const manualQty = document.getElementById('manualQty');
    const priceInput = document.getElementById('priceInput');
    const progressBar = document.getElementById('sliderProgress');

    // Initial Values
    document.getElementById('cropNameDisplay').textContent = cropName;
    document.getElementById('marketRateDisplay').textContent = marketRate;
    priceInput.value = marketRate; // Pre-fill with market rate, but editable
    document.getElementById('harvestDate').min = new Date().toISOString().split('T')[0];

    // --- 2. CALCULATOR LOGIC ---
    function updateCalculations() {
        const qty = parseFloat(manualQty.value) || 0;
        const price = parseFloat(priceInput.value) || 0;
        const total = qty * price;

        // Update Result Text
        document.getElementById('totalMath').textContent = '‚Çπ' + total.toLocaleString('en-IN');
        
        // Update Breakdown Text
        document.getElementById('qtyMath').textContent = qty;
        document.getElementById('priceMath').textContent = price.toLocaleString('en-IN');

        // Update Slider Visuals
        const percentage = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
        progressBar.style.width = percentage + '%';
    }

    // --- 3. EVENT LISTENERS ---
    
    // Slider Drag (Updates Quantity)
    slider.addEventListener('input', (e) => {
        manualQty.value = e.target.value;
        updateCalculations();
    });

    // Manual Quantity Input
    manualQty.addEventListener('input', (e) => {
        let val = e.target.value;
        if(val > 100) val = 100; // Cap max
        slider.value = val;
        updateCalculations();
    });

    // Price Input Change (THE NEW FEATURE)
    priceInput.addEventListener('input', () => {
        updateCalculations();
    });

    // Initialize
    updateCalculations();

    // --- 4. PHOTO PREVIEW ---
    function previewImage(input, imgId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById(imgId);
                img.src = e.target.result;
                img.style.display = 'block';
                input.parentElement.classList.add('has-image');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 5. SUBMIT ---
    function submitSellRequest() {
        const qty = manualQty.value;
        const price = priceInput.value;
        const date = document.getElementById('harvestDate').value;

        if(!date) {
            alert("Please select a date.");
            return;
        }

        const btn = document.getElementById('submitBtn');
        btn.innerHTML = "Processing...";
        btn.disabled = true;

        const payload = {
            crop: cropName,
            quantity: qty,
            price_per_quintal: price, // Now sends USER SET price
            total_value: qty * price,
            harvest_date: date
        };

        console.log("Submitting Sell Request:", payload);

        setTimeout(() => {
            alert("Request Submitted! \nYour Price: ‚Çπ" + price + "/Qtl");
            window.location.href = '/market/all-deals';
        }, 1500);
    }
</script>

{% endblock %}