{% extends "base.html" %}

{% block title %}Browse Auctions - Mandi Connect{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/bidding.css') }}">
{% endblock %}

{% block content %}
<div class="auction-browse-container">
    <!-- Header Section -->
    <div class="browse-header">
        <h1>üåæ Live Auctions</h1>
        <p class="subtitle">Find the best deals from farmers near you</p>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <div class="filters-grid">
            <!-- Crop Filter -->
            <div class="filter-group">
                <label for="cropFilter">Crop Type</label>
                <select id="cropFilter" onchange="applyFilters()">
                    <option value="">All Crops</option>
                    <option value="Soybean">Soybean</option>
                    <option value="Sunflower">Sunflower</option>
                    <option value="Safflower">Safflower</option>
                    <option value="Groundnut">Groundnut</option>
                    <option value="Castor">Castor</option>
                    <option value="Mustard">Mustard</option>
                    <option value="Coconut">Coconut</option>
                </select>
            </div>

            <!-- Price Filter -->
            <div class="filter-group">
                <label for="maxPrice">Max Base Price (‚Çπ)</label>
                <input type="number" id="maxPrice" placeholder="e.g., 10000" onchange="applyFilters()">
            </div>

            <!-- Sort Filter -->
            <div class="filter-group">
                <label for="sortBy">Sort By</label>
                <select id="sortBy" onchange="applyFilters()">
                    <option value="newest">Newest First</option>
                    <option value="ending_soon">Ending Soon</option>
                    <option value="price_low">Price: Low to High</option>
                    <option value="price_high">Price: High to Low</option>
                    <option value="most_bids">Most Bids</option>
                </select>
            </div>

            <!-- Location Filter -->
            <div class="filter-group">
                <label for="location">Location</label>
                <input type="text" id="location" placeholder="e.g., Indore, MP" onchange="applyFilters()">
            </div>

            <!-- Clear Filters Button -->
            <button class="btn-secondary" onclick="clearFilters()">Clear Filters</button>
        </div>
    </div>

    <!-- Auctions Grid -->
    <div class="auctions-grid" id="auctionsContainer">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading auctions...</p>
        </div>
    </div>

    <!-- No Results Message -->
    <div id="noResults" class="no-results" style="display: none;">
        <div class="no-results-content">
            <h2>üòï No auctions found</h2>
            <p>Try adjusting your filters or check back later</p>
        </div>
    </div>

    <!-- Stats Footer -->
    <div class="stats-footer">
        <div class="stat-item">
            <span class="stat-number" id="totalAuctions">0</span>
            <span class="stat-label">Active Auctions</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="uniqueSellers">0</span>
            <span class="stat-label">Sellers</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="totalValue">‚Çπ0</span>
            <span class="stat-label">Total Value</span>
        </div>
    </div>
</div>

<!-- Auction Card Modal/Preview -->
<template id="auctionCardTemplate">
    <div class="auction-card">
        <!-- Image Section -->
        <div class="auction-image">
            <img id="auctionImg" src="{{ url_for('static', filename='img/placeholder.jpg') }}" alt="Auction">
            <div class="auction-status" id="status">LIVE</div>
            <div class="time-remaining" id="timeRemaining">24h remaining</div>
        </div>

        <!-- Content Section -->
        <div class="auction-content">
            <!-- Crop Info -->
            <div class="crop-header">
                <h3 id="cropName" class="crop-title">Soybean</h3>
                <span class="location-badge" id="location">üìç Indore, MP</span>
            </div>

            <!-- Price Section -->
            <div class="price-section">
                <div class="price-item">
                    <span class="price-label">Base Price</span>
                    <span class="price-value" id="basePrice">‚Çπ5,500</span>
                </div>
                <div class="price-item">
                    <span class="price-label">Min Bid</span>
                    <span class="price-value" id="minBid">‚Çπ5,500</span>
                </div>
                <div class="price-item highlight">
                    <span class="price-label">Current Bid</span>
                    <span class="price-value" id="currentBid">‚Çπ5,650</span>
                </div>
            </div>

            <!-- Quantity & Bids -->
            <div class="stats-row">
                <div class="stat">
                    <span class="stat-icon">‚öñÔ∏è</span>
                    <span id="quantity">10 Q</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">üí∞</span>
                    <span id="bidCount">5 Bids</span>
                </div>
                <div class="stat">
                    <span class="stat-icon">üë•</span>
                    <span id="bidders">3 Bidders</span>
                </div>
            </div>

            <!-- Seller Info -->
            <div class="seller-info">
                <div class="seller-badge">
                    <span class="seller-icon">üë®‚Äçüåæ</span>
                    <div class="seller-details">
                        <span class="seller-name" id="sellerName">Farmer Name</span>
                        <span class="seller-rating">‚≠ê 4.5</span>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <button class="btn-primary btn-full" id="viewBtn" onclick="viewAuctionDetail()">
                View & Bid ‚Üí
            </button>
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/bidding.js') }}"></script>
<script>
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadAuctions();
        setupAutoRefresh();
    });

    // Load auctions from API
    function loadAuctions() {
        const params = new URLSearchParams({
            crop: document.getElementById('cropFilter').value || undefined,
            max_price: document.getElementById('maxPrice').value || undefined,
            sort: document.getElementById('sortBy').value || 'newest',
            location: document.getElementById('location').value || undefined
        });

        fetch(`/bidding/buyer/auctions?${params}`)
            .then(res => res.json())
            .then(data => {
                renderAuctions(data.auctions);
                updateStats(data);
            })
            .catch(err => {
                console.error('Error loading auctions:', err);
                showError('Failed to load auctions. Please try again.');
            });
    }

    // Render auction cards
    function renderAuctions(auctions) {
        const container = document.getElementById('auctionsContainer');
        const noResults = document.getElementById('noResults');

        if (auctions.length === 0) {
            container.innerHTML = '';
            noResults.style.display = 'block';
            return;
        }

        noResults.style.display = 'none';
        container.innerHTML = auctions.map(auction => {
            const template = document.getElementById('auctionCardTemplate').content.cloneNode(true);
            
            // Set data attributes
            template.querySelector('.auction-card').dataset.auctionId = auction.id;
            
            // Fill template
            template.getElementById('cropName').textContent = auction.crop_name;
            template.getElementById('location').textContent = `üìç ${auction.location || 'Location TBD'}`;
            template.getElementById('basePrice').textContent = `‚Çπ${formatNumber(auction.base_price)}`;
            template.getElementById('minBid').textContent = `‚Çπ${formatNumber(auction.min_bid)}`;
            template.getElementById('currentBid').textContent = `‚Çπ${formatNumber(auction.current_bid)}`;
            template.getElementById('quantity').textContent = `${auction.quantity} Q`;
            template.getElementById('bidCount').textContent = `${auction.bids_count || 0} Bids`;
            template.getElementById('bidders').textContent = `${auction.bidders_count || 0} Bidders`;
            template.getElementById('sellerName').textContent = auction.seller_name || 'Farmer';
            template.getElementById('timeRemaining').textContent = getTimeRemaining(auction.end_time);
            
            // Set image
            if (auction.photo1_path) {
                template.getElementById('auctionImg').src = auction.photo1_path;
            }

            // Click handler
            template.getElementById('viewBtn').onclick = () => {
                window.location.href = `/bidding/auction-detail/${auction.id}`;
            };

            return template;
        }).reduce((frag, node) => {
            frag.appendChild(node);
            return frag;
        }, document.createDocumentFragment());
    }

    // Apply filters
    function applyFilters() {
        loadAuctions();
    }

    // Clear filters
    function clearFilters() {
        document.getElementById('cropFilter').value = '';
        document.getElementById('maxPrice').value = '';
        document.getElementById('sortBy').value = 'newest';
        document.getElementById('location').value = '';
        loadAuctions();
    }

    // Update statistics
    function updateStats(data) {
        document.getElementById('totalAuctions').textContent = data.total || 0;
        document.getElementById('uniqueSellers').textContent = data.sellers_count || 0;
        document.getElementById('totalValue').textContent = `‚Çπ${formatNumber(data.total_value || 0)}`;
    }

    // Setup auto-refresh
    function setupAutoRefresh() {
        setInterval(loadAuctions, 30000); // Refresh every 30 seconds
    }

    // Helper functions
    function formatNumber(num) {
        return new Intl.NumberFormat('en-IN').format(num);
    }

    function getTimeRemaining(endTime) {
        const now = new Date();
        const end = new Date(endTime);
        const diff = end - now;

        if (diff <= 0) return 'Ended';
        
        const hours = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        
        if (hours > 0) return `${hours}h remaining`;
        return `${minutes}m remaining`;
    }

    function showError(message) {
        const container = document.getElementById('auctionsContainer');
        container.innerHTML = `<div class="error-message">${message}</div>`;
    }
</script>
{% endblock %}
