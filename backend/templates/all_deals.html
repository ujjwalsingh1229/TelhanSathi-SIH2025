{% extends "base.html" %}

{% block title %}My Deals - Telhan Sathi{% endblock %}

{% block content %}
        <!-- Header -->
            <div class="header-item"   >              
                <div class="header-title">My Deals</div>
            </div>
   

        <!-- Main Content -->
        <div class="main-content">
            <!-- Filter Buttons -->
            <div class="filters">
                <button class="filter-btn active" onclick="filterDeals(event,'all')">All</button>
                <button class="filter-btn" onclick="filterDeals(event,'pending')">Pending</button>
                <button class="filter-btn" onclick="filterDeals(event,'accepted')">Accepted</button>
                <button class="filter-btn" onclick="filterDeals(event,'declined')">Declined</button>
                <button class="filter-btn" onclick="filterDeals(event,'final_confirmed')">Confirmed</button>
            </div>

            <!-- Deals Container -->
            <div id="dealsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Loading deals...</p>
                </div>
            </div>
            <br><br><br><br><br><br>
        </div>

    <style>
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 8px
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: #fff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            color: #666;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .filter-btn.active {
            border-color: #4caf50;
            background: #4caf50;
            color: #fff;
        }

        .filter-btn:hover {
            border-color: #4caf50;
            color: #4caf50;
        }

        /* Deal Card */
        .deal-card {
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #ff9800;
            cursor: pointer;
            transition: all 0.3s;
        }

        .deal-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* Status Colors */
        .deal-card.pending { border-left-color: #ff9800; }
        .deal-card.accepted { border-left-color: #4caf50; }
        .deal-card.declined { border-left-color: #f44336; }
        .deal-card.final_confirmed { border-left-color: #2196f3; }

        .deal-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .deal-crop {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-pending { background: #fff3e0; color: #ff9800; }
        .status-accepted { background: #e8f5e9; color: #4caf50; }
        .status-declined { background: #ffebee; color: #f44336; }
        .status-final_confirmed { background: #e3f2fd; color: #2196f3; }

        .deal-info {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #666;
            margin: 8px 0;
        }

        .deal-quantity {
            font-weight: 500;
            color: #333;
        }

        .deal-price {
            font-size: 16px;
            font-weight: bold;
            color: #d84315;
            margin-top: 5px;
        }

        .deal-date {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 300px;
            text-align: center;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .empty-text {
            font-size: 13px;
            color: #999;
            margin-bottom: 20px;
        }

        .btn-create {
            padding: 10px 20px;
            background: #4caf50;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }

        .btn-create:hover {
            background: #388e3c;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4caf50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
        }
    </style>
{% endblock %}

{% block script %}
    <script>
        let allDeals = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            loadDeals();
        });

        async function loadDeals() {
            try {
                const response = await fetch('/market/deals-list');
                if (response.ok) {
                    allDeals = await response.json();
                    console.log('Loaded deals', allDeals.length, allDeals);
                    displayDeals(allDeals);
                } else {
                    showError('Failed to load deals');
                }
            } catch (error) {
                console.error('Error loading deals:', error);
                showError('An error occurred while loading deals');
            }
        }

        function filterDeals(e, status) {
            currentFilter = status;

            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const target = e && e.target ? e.target : null;
            if (target) target.classList.add('active');

            // Filter and display
            if (status === 'all') {
                displayDeals(allDeals);
            } else {
                const filtered = allDeals.filter(deal => deal.status === status);
                displayDeals(filtered);
            }
        }

        function displayDeals(deals) {
            const container = document.getElementById('dealsContainer');

            if (deals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-title">No Deals Yet</div>
                        <div class="empty-text">Create your first sell request to get started</div>
                        <button class="btn-create" onclick="window.location.href='/market/select'">Create Sell Request</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = deals.map(deal => `
                <div class="deal-card ${deal.status}" onclick="viewDealDetails('${deal.id}')">
                    <div class="deal-header">
                        <div class="deal-crop">${deal.crop_name}</div>
                        <span class="status-badge status-${deal.status}">${formatStatus(deal.status)}</span>
                    </div>

                    <div class="deal-info">
                        <span><strong>Qty:</strong> ${deal.quantity_quintal} Q</span>
                        <span><strong>Harvest:</strong> ${formatDate(deal.harvest_date)}</span>
                    </div>

                    <div class="deal-price">‚Çπ${deal.expected_price} / Quintal</div>

                    ${deal.buyer_price ? `
                        <div class="deal-info" style="margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px;">
                            <span><strong>Buyer Offer:</strong> ‚Çπ${deal.buyer_price} / Q</span>
                        </div>
                    ` : ''}

                    <div class="deal-date">Created: ${formatDateTime(deal.created_at)}</div>
                </div>
            `).join('');
        }

        function formatStatus(status) {
            const statuses = {
                'pending': 'Pending',
                'accepted': 'Accepted',
                'declined': 'Declined',
                'final_confirmed': 'Confirmed'
            };
            return statuses[status] || status;
        }

        function formatDate(dateStr) {
            // Handle null/empty
            if (!dateStr) return '-';

            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                // Invalid date ‚Äî return raw string or placeholder
                return dateStr || '-';
            }

            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
            } catch {
                return dateStr;
            }
        }

        function viewDealDetails(dealId) {
            window.location.href = `/market/deal-details/${dealId}`;
        }

        function goBack() {
            window.history.back();
        }

        function showError(message) {
            const container = document.getElementById('dealsContainer');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <div class="empty-title">Error</div>
                    <div class="empty-text">${message}</div>
                    <button class="btn-create" onclick="location.reload()">Retry</button>
                </div>
            `;
        }
    </script>
{% endblock %}
